---
import LandingLayout from '@/layouts/LandingLayout.astro';
import IAHero from '@/components/pages/ia-contadores/IAHero.astro';
import IALearning from '@/components/pages/ia-contadores/IALearning.astro';
import IATestimonials from '@/components/pages/ia-contadores/IATestimonials.astro';
import IAAudience from '@/components/pages/ia-contadores/IAAudience.astro';
import IAWhyFree from '@/components/pages/ia-contadores/IAWhyFree.astro';
import IAInstructor from '@/components/pages/ia-contadores/IAInstructor.astro';
import IAFaq from '@/components/pages/ia-contadores/IAFaq.astro';
import IAFinalCTA from '@/components/pages/ia-contadores/IAFinalCTA.astro';
import MasterclassSEO from '@/components/seo/MasterclassSEO.astro';

const title =
  'Masterclass GRATIS - Por Qué el 90% de los Contadores Usa IA de Forma Incorrecta';
const description =
  'Descubre el framework que te permitirá usar ChatGPT, Claude y Gemini 3 como estratega. 45 minutos que cambiarán tu perspectiva sobre IA.';
const keywords = [
  'masterclass IA contadores',
  'ChatGPT para contadores',
  'Claude AI',
  'Gemini 3',
  'IA para contabilidad',
  'curso gratuito IA',
  'webinar contadores',
];
---

<LandingLayout
  title={title}
  description={description}
  keywords={keywords}
  showFooter={false}
  category="ia"
>
  <MasterclassSEO slot="head" />
  <IAHero />
  <IALearning />
  <IATestimonials />
  <IAAudience />
  <IAWhyFree />
  <IAInstructor />
  <IAFaq />
  <IAFinalCTA />
</LandingLayout>

<script>
  // ========================================
  // INTERSECTION OBSERVER - ANIMATIONS
  // ========================================
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px',
  };

  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const delay = entry.target.getAttribute('data-delay') || 0;
        setTimeout(() => {
          entry.target.classList.add('animated');
        }, parseInt(delay));
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);

  document.querySelectorAll('.animate-on-scroll').forEach(el => {
    observer.observe(el);
  });

  // ========================================
  // SMOOTH SCROLL TO EVENTS
  // ========================================
  document.querySelectorAll('.scroll-to-events').forEach(button => {
    button.addEventListener('click', e => {
      e.preventDefault();
      const heroSection = document.getElementById('hero');
      if (heroSection) {
        heroSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  });

  // ========================================
  // ANALYTICS TRACKING
  // ========================================
  function trackEvent(eventName, eventData = {}) {
    // Google Analytics 4
    if (typeof window !== 'undefined' && 'gtag' in window) {
      window.gtag('event', eventName, eventData);
    }

    // Plausible Analytics
    if (typeof window !== 'undefined' && 'plausible' in window) {
      window.plausible(eventName, { props: eventData });
    }

    // Facebook Pixel
    if (typeof window !== 'undefined' && 'fbq' in window) {
      window.fbq('track', eventName, eventData);
    }

    // Console log for debugging
    console.log('Track Event:', eventName, eventData);
  }

  // Expose trackEvent globally so components can use it
  window.trackEvent = trackEvent;

  // Track CTA clicks
  document.querySelectorAll('[data-track-event]').forEach(button => {
    button.addEventListener('click', e => {
      const eventName = e.currentTarget.getAttribute('data-track-event');
      if (eventName) {
        trackEvent(eventName, {
          button_location: eventName.includes('hero') ? 'hero' : 'footer',
          button_text: e.currentTarget.textContent?.trim(),
        });
      }
    });
  });

  // Track scroll depth
  let maxScroll = 0;
  const scrollMilestones = [25, 50, 75, 100];
  const trackedMilestones = new Set();

  window.addEventListener('scroll', () => {
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollPercent = (scrollTop / (documentHeight - windowHeight)) * 100;

    if (scrollPercent > maxScroll) {
      maxScroll = scrollPercent;

      scrollMilestones.forEach(milestone => {
        if (scrollPercent >= milestone && !trackedMilestones.has(milestone)) {
          trackedMilestones.add(milestone);
          trackEvent('scroll_depth', {
            percent: milestone,
          });
        }
      });
    }
  });

  // Track FAQ interactions
  document.querySelectorAll('.faq-item').forEach(item => {
    item.addEventListener('toggle', () => {
      if (item.hasAttribute('open')) {
        const question = item
          .querySelector('.faq-question')
          ?.textContent?.trim();
        trackEvent('faq_opened', {
          question: question || 'unknown',
        });
      }
    });
  });

  // Track time on page
  const startTime = Date.now();
  window.addEventListener('beforeunload', () => {
    const timeOnPage = Math.round((Date.now() - startTime) / 1000);
    trackEvent('time_on_page', {
      seconds: timeOnPage,
    });
  });

  // Track section visibility
  const sectionObserver = new IntersectionObserver(
    entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting && entry.target instanceof HTMLElement) {
          const sectionName =
            entry.target.className.split(' ')[0] || 'unknown_section';
          trackEvent('section_viewed', {
            section: sectionName,
          });
          sectionObserver.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.5 }
  );

  document.querySelectorAll('section').forEach(section => {
    sectionObserver.observe(section);
  });
</script>
