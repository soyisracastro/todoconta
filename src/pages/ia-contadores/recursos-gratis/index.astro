---
import LandingLayout from '@/layouts/LandingLayout.astro';
import IARecursosHero from '@/components/pages/ia-contadores/IARecursosHero.astro';
import IARecursosVisual from '@/components/pages/ia-contadores/IARecursosVisual.astro';
import IARecursosFeatures from '@/components/pages/ia-contadores/IARecursosFeatures.astro';
import IARecursosPreview from '@/components/pages/ia-contadores/IARecursosPreview.astro';
import IARecursosTestimonials from '@/components/pages/ia-contadores/IARecursosTestimonials.astro';
import IARecursosUpsell from '@/components/pages/ia-contadores/IARecursosUpsell.astro';
import IARecursosSchema from '@/components/pages/ia-contadores/IARecursosSchema.astro';

const title =
  'Descarga Gratis: 3 Casos Pr√°cticos de IA para Contadores | TodoConta';
const description =
  'Los flujos completos que ahorran 6-10 horas semanales + 10 plantillas de prompts + matriz de decisi√≥n. Recursos gratuitos para contadores.';
const keywords = [
  'casos pr√°cticos IA contadores',
  'plantillas prompts contabilidad',
  'ChatGPT para contadores',
  'Claude AI contabilidad',
  'matriz decisi√≥n IA',
  'recursos gratuitos IA',
  'prompts contadores',
];

// Configuration
---

<LandingLayout
  title={title}
  description={description}
  keywords={keywords}
  showFooter={false}
>
  <IARecursosSchema />

  <div class="theme-ia tech-bg min-h-screen">
    <div class="relative flex justify-center w-full py-20 px-4 md:px-8">
      <div class="container mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 items-start">
          <!-- LEFT COLUMN (Main Content) -->
          <div class="lg:col-span-7 flex flex-col gap-12">
            <!-- 1. Hero Header Section -->
            <IARecursosHero />

            <!-- 2. Visual Principal -->
            <IARecursosVisual />

            <!-- 3. Section "Lo Que Vas a Recibir" -->
            <IARecursosFeatures />

            <!-- 4. Grid "Vista Previa" & Social Proof -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12 pt-4">
              <IARecursosPreview />
              <IARecursosTestimonials />
            </div>
          </div>

          <!-- RIGHT COLUMN (Form - sticky) -->
          <div class="lg:col-span-5 lg:sticky lg:top-10">
            <div
              class="hero-form-container animate-on-scroll"
              data-animation="fade-in-up"
            >
              <div
                class="form-container !max-w-full bg-white dark:bg-gray-800 shadow-2xl border-white/50"
              >
                <h2
                  class="form-title !text-[#111118] dark:!text-white font-display"
                >
                  Descarga Tus Recursos Ahora
                </h2>
                <p class="form-subtitle text-sm">
                  Ingresa tus datos y recibe el PDF inmediatamente en tu email
                </p>

                <form id="lead-magnet-form" class="lead-form">
                  <div class="form-row">
                    <div class="form-group">
                      <label
                        for="name"
                        class="form-label !text-gray-700 dark:!text-gray-300"
                        >Nombre</label
                      >
                      <input
                        type="text"
                        id="name"
                        name="name"
                        class="form-input !bg-gray-50 dark:!bg-white/5 !text-gray-900 dark:!text-white !border-gray-200 dark:!border-white/10"
                        placeholder="Tu nombre completo"
                        required
                      />
                    </div>

                    <div class="form-group">
                      <label
                        for="email"
                        class="form-label !text-gray-700 dark:!text-gray-300"
                        >Email</label
                      >
                      <input
                        type="email"
                        id="email"
                        name="email"
                        class="form-input !bg-gray-50 dark:!bg-white/5 !text-gray-900 dark:!text-white !border-gray-200 dark:!border-white/10"
                        placeholder="tu@email.com"
                        required
                      />
                    </div>
                  </div>

                  <div class="form-group">
                    <label
                      for="challenge"
                      class="form-label !text-gray-700 dark:!text-gray-300"
                      >¬øCu√°l es tu MAYOR desaf√≠o actual con IA?</label
                    >
                    <select
                      id="challenge"
                      name="challenge"
                      class="form-select !bg-gray-50 dark:!bg-white/5 !text-gray-900 dark:!text-white !border-gray-200 dark:!border-white/10"
                      required
                    >
                      <option value="" disabled selected
                        >Selecciona una opci√≥n</option
                      >
                      <option value="overwhelmed"
                        >No s√© por d√≥nde empezar / Me abruma</option
                      >
                      <option value="basic_use"
                        >Uso IA pero de forma muy b√°sica</option
                      >
                      <option value="which_ai"
                        >No s√© cu√°l IA usar para cada tarea</option
                      >
                      <option value="prompts"
                        >No logro que me d√© respuestas √∫tiles</option
                      >
                      <option value="charge_more"
                        >Quiero cobrar m√°s por mis servicios</option
                      >
                      <option value="automate"
                        >Quiero automatizar tareas repetitivas</option
                      >
                    </select>
                  </div>

                  <div class="form-group">
                    <label
                      for="clients"
                      class="form-label !text-gray-700 dark:!text-gray-300"
                      >¬øCu√°ntos clientes contables manejas?</label
                    >
                    <select
                      id="clients"
                      name="clients"
                      class="form-select !bg-gray-50 dark:!bg-white/5 !text-gray-900 dark:!text-white !border-gray-200 dark:!border-white/10"
                      required
                    >
                      <option value="" disabled selected
                        >Selecciona una opci√≥n</option
                      >
                      <option value="0-5">0-5 clientes (empezando)</option>
                      <option value="6-15">6-15 clientes</option>
                      <option value="16-30">16-30 clientes</option>
                      <option value="31-50">31-50 clientes</option>
                      <option value="51+">51+ clientes</option>
                      <option value="corporate">Trabajo en corporativo</option>
                    </select>
                  </div>

                  <button
                    type="submit"
                    class="btn-submit !bg-blue-600 !text-white !shadow-blue-500/30 hover:!bg-blue-700 hover:!scale-[1.02] active:!scale-95 transition-all w-full h-14 rounded-xl font-black font-display uppercase tracking-wider"
                    id="submit-button"
                  >
                    üì• Descargar Recursos Gratis
                  </button>

                  <p class="form-privacy">
                    üîí No spam. Solo contenido de valor.
                  </p>

                  <div
                    id="form-message"
                    class="form-message"
                    style="display: none;"
                  >
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <IARecursosUpsell />
</LandingLayout>

<style>
  /* ========================================
     ANIMATIONS
     ======================================== */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideInLeft {
    from {
      opacity: 0;
      transform: translateX(-50px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(50px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .animate-on-scroll {
    opacity: 0;
  }

  .animate-on-scroll.animated {
    animation-duration: 0.8s;
    animation-fill-mode: forwards;
    animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  }

  .animated[data-animation='fade-in-up'] {
    animation-name: fadeInUp;
  }
  .animated[data-animation='fade-in-down'] {
    animation-name: fadeInDown;
  }
  .animated[data-animation='fade-in'] {
    animation-name: fadeIn;
  }
  .animated[data-animation='slide-in-left'] {
    animation-name: slideInLeft;
  }
  .animated[data-animation='slide-in-right'] {
    animation-name: slideInRight;
  }
  .animated[data-animation='scale-in'] {
    animation-name: scaleIn;
  }

  /* ========================================
     FORM STYLES
     ======================================== */
  .form-container {
    padding: var(--space-8);
    border-radius: var(--border-radius-2xl);
    background: white;
    box-shadow:
      0 10px 15px -3px rgba(0, 0, 0, 0.1),
      0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }

  .dark .form-container {
    background: #1f2937;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .form-title {
    font-size: 1.875rem;
    font-weight: 800;
    text-align: center;
    margin-bottom: 0.75rem;
    line-height: 1.2;
  }

  .form-subtitle {
    color: #6b7280;
    text-align: center;
    margin-bottom: 2rem;
  }

  .dark .form-subtitle {
    color: #9ca3af;
  }

  .lead-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  @media (min-width: 640px) {
    .form-row {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-label {
    font-size: 0.875rem;
    font-weight: 600;
  }

  .form-input,
  .form-select {
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    font-size: 1rem;
    transition: all 0.2s ease;
  }

  .form-input:focus,
  .form-select:focus {
    outline: none;
    border-color: #2563eb;
    ring: 2px solid rgba(37, 99, 235, 0.2);
  }

  .form-privacy {
    font-size: 0.75rem;
    color: #6b7280;
    text-align: center;
    margin: 0;
  }

  .dark .form-privacy {
    color: #9ca3af;
  }

  .form-message {
    padding: 1rem;
    border-radius: 0.75rem;
    font-size: 1rem;
    text-align: center;
  }

  .form-message.success {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid #10b981;
    color: #059669;
  }

  .form-message.error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid #ef4444;
    color: #dc2626;
  }
</style>

<script>
  // ========================================
  // CONFIGURATION
  // ========================================
  const SENDY_ENDPOINT = 'https://sendy.todoconta.com/subscribe';
  const SENDY_LIST_ID = 'vzn2EzpQzSnPJiEf4jR6Kg';
  const THANK_YOU_PAGE = '/ia-contadores/recursos-gratis/gracias';

  // ========================================
  // INTERSECTION OBSERVER - ANIMATIONS
  // ========================================
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px',
  };

  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const delay = entry.target.getAttribute('data-delay') || 0;
        setTimeout(() => {
          entry.target.classList.add('animated');
        }, parseInt(delay));
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);

  document.querySelectorAll('.animate-on-scroll').forEach(el => {
    observer.observe(el);
  });

  // ========================================
  // FORM HANDLING
  // ========================================
  const form = document.getElementById(
    'lead-magnet-form'
  ) as HTMLFormElement | null;
  const submitButton = document.getElementById(
    'submit-button'
  ) as HTMLButtonElement | null;
  const formMessage = document.getElementById(
    'form-message'
  ) as HTMLDivElement | null;

  if (form && submitButton && formMessage) {
    form.addEventListener('submit', async e => {
      e.preventDefault();

      // Get form data
      const formData = new FormData(form);
      const name = formData.get('name') as string;
      const email = formData.get('email') as string;
      const challenge = formData.get('challenge') as string;
      const clients = formData.get('clients') as string;

      // Basic validation
      if (!name || !email || !challenge || !clients) {
        showMessage('Por favor completa todos los campos requeridos.', 'error');
        return;
      }

      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showMessage('Por favor ingresa un email v√°lido.', 'error');
        return;
      }

      // Disable submit button
      submitButton.disabled = true;
      submitButton.textContent = '‚è≥ Enviando...';

      try {
        // Preparar los datos para Sendy
        const sendyData = new FormData();
        sendyData.append('name', name);
        sendyData.append('email', email);
        sendyData.append('Challenge', challenge);
        sendyData.append('Clients', clients);
        sendyData.append('list', SENDY_LIST_ID);
        sendyData.append('api_key', import.meta.env.PUBLIC_SENDY_API_KEY);
        sendyData.append('boolean', 'true');

        // Enviar a Sendy
        const response = await fetch(SENDY_ENDPOINT, {
          method: 'POST',
          body: sendyData,
        });

        const result = await response.text();

        if (
          result === '1' ||
          result.includes('subscribed') ||
          result.includes('Already subscribed')
        ) {
          // Track conversion
          trackEvent('lead_magnet_submit', {
            email: email,
            challenge: challenge,
            clients: clients,
          });

          // Show success message
          showMessage(
            '¬°Perfecto! Revisa tu email para descargar los recursos.',
            'success'
          );

          // Reset form
          form.reset();

          // Redirect to thank you page after 2 seconds
          setTimeout(() => {
            window.location.href = THANK_YOU_PAGE;
          }, 2000);
        } else {
          throw new Error('Subscription failed: ' + result);
        }
      } catch (error) {
        console.error('Form submission error:', error);
        showMessage(
          'Hubo un error al enviar el formulario. Por favor intenta nuevamente.',
          'error'
        );
        submitButton.disabled = false;
        submitButton.textContent = 'üì• Descargar Recursos Gratis';
      }
    });
  }

  function showMessage(message: string, type: 'success' | 'error') {
    if (!formMessage) return;

    formMessage.textContent = message;
    formMessage.className = `form-message ${type}`;
    formMessage.style.display = 'block';

    // Hide message after 5 seconds
    setTimeout(() => {
      formMessage.style.display = 'none';
    }, 5000);
  }

  // ========================================
  // ANALYTICS TRACKING
  // ========================================
  function trackEvent(eventName: string, eventData = {}) {
    // Google Analytics 4
    if (typeof window !== 'undefined' && 'gtag' in window) {
      (window as any).gtag('event', eventName, eventData);
    }

    // Plausible Analytics
    if (typeof window !== 'undefined' && 'plausible' in window) {
      (window as any).plausible(eventName, { props: eventData });
    }

    // Facebook Pixel
    if (typeof window !== 'undefined' && 'fbq' in window) {
      (window as any).fbq('track', eventName, eventData);
    }

    // Console log for debugging
    console.log('Track Event:', eventName, eventData);
  }

  // Track CTA clicks
  document.querySelectorAll('[data-track-event]').forEach(button => {
    button.addEventListener('click', e => {
      const eventName = (e.currentTarget as HTMLElement).getAttribute(
        'data-track-event'
      );
      if (eventName) {
        trackEvent(eventName, {
          button_text: (e.currentTarget as HTMLElement).textContent?.trim(),
        });
      }
    });
  });

  // Track scroll depth
  let maxScroll = 0;
  const scrollMilestones = [25, 50, 75, 100];
  const trackedMilestones = new Set<number>();

  window.addEventListener('scroll', () => {
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollPercent = (scrollTop / (documentHeight - windowHeight)) * 100;

    if (scrollPercent > maxScroll) {
      maxScroll = scrollPercent;

      scrollMilestones.forEach(milestone => {
        if (scrollPercent >= milestone && !trackedMilestones.has(milestone)) {
          trackedMilestones.add(milestone);
          trackEvent('scroll_depth', {
            percent: milestone,
            page: 'recursos-gratis',
          });
        }
      });
    }
  });
</script>
