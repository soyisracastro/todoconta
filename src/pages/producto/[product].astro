---
export const prerender = true;
// src/pages/landing/[product].astro
import { getCollection } from 'astro:content';
import LandingLayout from '../../layouts/LandingLayout.astro';
import HeroProduct from '../../components/ui/HeroProduct.astro';
import DigitalProductHero from '../../components/products/DigitalProductHero.astro';
import DiotVisual from '../../components/products/visuals/DiotVisual.astro';
import ProblemSection from '../../components/products/ProblemSection.astro';
import FeaturesSection from '../../components/products/FeaturesSection.astro';
import BenefitsSection from '../../components/products/BenefitsSection.astro';
import ProductCTA from '../../components/products/ProductCTA.astro';
import FinalCTA from '../../components/products/FinalCTA.astro';
import FAQSection from '../../components/products/FAQSection.astro';
import Features from '../../components/pages/landing/Features.astro';
import Benefits from '../../components/pages/landing/Benefits.astro';
import PricingPlans from '../../components/pages/landing/PricingPlans.astro';
import Demo from '../../components/pages/landing/Demo.astro';
import FAQ from '../../components/ui/FAQ.astro';
import PaymentSection from '../../components/products/PaymentSection.astro';
import ProductSEO from '../../components/seo/ProductSEO.astro';

// Genera rutas para cada producto
export async function getStaticPaths() {
  const products = await getCollection('products');

  return products.map(product => ({
    params: { product: product.slug },
    props: { product },
  }));
}

const { product } = Astro.props;
if (!product || !product.data) {
  throw new Error(`Product data not found for slug: ${Astro.params.product}`);
}
const {
  title,
  description,
  price,
  pricePeriod,
  badge,
  heroImage,
  features,
  benefits,
  pricing,
  faqs,
  formId,
  plans,
  problemSection,
  featuresSection,
  ctaSection,
  benefitsSection,
  finalCta,
  faqSection,
  category,
} = product.data;

// Calculate price display
let priceDisplay = undefined;
if (price && pricePeriod) {
  // Single fixed price
  priceDisplay = `$${price.toLocaleString()}/${pricePeriod}`;
} else if (plans && plans.length > 0) {
  // Price range from plans
  const prices = plans.map(plan => plan.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const period = plans[0].pricePeriod || 'mes'; // Use first plan's period as default
  priceDisplay = {
    min: `$${minPrice.toLocaleString()}`,
    max: `$${maxPrice.toLocaleString()}/${period}`,
  };
}

// Prepara los datos para los componentes
const heroProps = {
  title,
  description,
  primaryCta: {
    text: 'Comprar Ahora',
    url: '#pricing',
  },
  ...(badge && { badge }),
  ...(priceDisplay && { price: priceDisplay }),
  ...(formId && {
    secondaryCta: {
      text: 'Descargar Demo',
      url: '#demo',
    },
  }),
  ...(heroImage && { image: heroImage }),
};

const featuresProps = {
  title: 'Funciones Principales',
  subtitle: `${title} ofrece potentes herramientas para optimizar tu trabajo.`,
  features,
};

const benefitsProps = {
  title: 'Beneficios para tu Negocio',
  subtitle: `${title} está diseñado para optimizar tus procesos.`,
  benefits,
};

const pricingPlansProps = plans
  ? {
      title: 'Elige tu Licencia',
      subtitle: `Selecciona el número de licencias de ${title} que mejor se adapte a tu negocio.`,
      plans,
      showBankTransferCta: true, // Mostrar CTA de transferencia bancaria en planes múltiples
      productId: product.slug,
      isPaymentButton: true, // Enable payment buttons for plans
    }
  : null;

const demoProps = formId
  ? {
      formId,
    }
  : null;

// Keywords para SEO
const keywords = [
  title.split(' ').join(', '),
  ...features.map(f => f.title),
  ...benefits.map(b => b.title),
  'Todoconta',
  'software contable',
  'herramientas fiscales',
];

// Verificar que todas las propiedades necesarias estén disponibles
const hasValidFeatures =
  features && Array.isArray(features) && features.length > 0;
const hasValidBenefits =
  benefits && Array.isArray(benefits) && benefits.length > 0;
const hasValidPricing =
  pricing && pricing.features && Array.isArray(pricing.features) && price;
const hasValidPlans = plans && Array.isArray(plans) && plans.length > 0;
const hasValidFaqs = faqs && Array.isArray(faqs) && faqs.length > 0;

const paymentProps = hasValidPricing
  ? {
      productTitle: title,
      productVersion:
        product.slug === 'plantilla-carga-batch-diot'
          ? 'Versión 2.0 • Carga Batch Automatizada'
          : undefined,
      price: price as number,
      features: pricing.features,
      productId: product.slug,
    }
  : undefined;

// SEO data para ProductSEO
const productSeoProps = {
  name: title,
  description: description,
  url: new URL(`/producto/${product.slug}`, Astro.site || Astro.url).href,
  ...(price && { price, pricePeriod }),
  ...(plans && plans.length > 0 && { plans }),
  category,
  sku: product.slug.toUpperCase(),
  ...(heroImage && { image: heroImage }),
  ...(faqs && faqs.length > 0 && { faqs }),
};
---

<LandingLayout
  title={title}
  description={description}
  keywords={keywords}
  category={category}
  {...heroImage && { ogImage: heroImage }}
>
  <ProductSEO slot="head" {...productSeoProps} />

  <!-- Hero Section -->
  {
    product.slug === 'plantilla-carga-batch-diot' ? (
      <>
        <DigitalProductHero {...heroProps}>
          <DiotVisual slot="visual" />
        </DigitalProductHero>
        {problemSection && <ProblemSection {...problemSection} />}
        {featuresSection && <FeaturesSection {...featuresSection} />}
        {ctaSection && <ProductCTA {...ctaSection} />}
        {benefitsSection && <BenefitsSection {...benefitsSection} />}
        {finalCta && <FinalCTA {...finalCta} />}
        {faqSection && <FAQSection {...faqSection} />}
        {paymentProps && <PaymentSection {...paymentProps} />}
      </>
    ) : (
      <HeroProduct {...heroProps} />
      <!-- Features Section -->
      {hasValidFeatures && <Features {...featuresProps} />}
    
      <!-- Benefits Section -->
      {hasValidBenefits && <Benefits {...benefitsProps} />}
    
      <!-- Pricing Section -->
      {hasValidPricing && <PaymentSection {...paymentProps!} />}
    
      <!-- Pricing Plans Section (for products with multiple plans) -->
      {hasValidPlans && <PricingPlans {...pricingPlansProps} />}
    
      <!-- Demo Section (if available) -->
      {demoProps && <Demo {...demoProps} />}
    
      <!-- FAQ Section (if available) -->
      {hasValidFaqs && !faqSection && <FAQ faqs={faqs} />}
    )
  }

</LandingLayout>
